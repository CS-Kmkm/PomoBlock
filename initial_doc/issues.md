# BlockSched v1 Issue分解

本ドキュメントは、`blocksched_spec.md` と `blocksched_concept.md` を実装可能な粒度へ落とした Issue 一覧。

## 1. 運用ルール
- ID 形式: `BS-xxx`
- 優先度: `P0`（最優先） / `P1`（重要） / `P2`（後続）
- 見積: 実作業日ベース
- 依存: 先行完了が必要な Issue ID

## 2. Epic 一覧
| Epic | 目的 |
| --- | --- |
| E0 基盤 | 型・設定・状態管理の土台を作る |
| E1 Calendar 同期 | OAuth と syncToken 差分同期を安定化 |
| E2 生成 MVP | 冪等生成、suppression、手動生成を成立 |
| E3 配置戦略 | Freebusy と shift で衝突回避を実現 |
| E4 実行導線 | CLI・自動実行・最小 UI を提供 |
| E5 実績ログ | ポモドーロ実績と監査ログを整備 |
| E6 Git 同期 | 設定同期と競合運用を整備 |
| E7 品質保証 | 回帰試験とリリース品質を担保 |

## 3. Issue 一覧

### E0 基盤
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-001 | プロジェクト骨組み作成 | `src/config/state/logs` と実行エントリを作成 | ローカル実行で設定読込の最小フローが動作 | - | P0 | 1日 |
| BS-002 | 設定スキーマ実装 | `app/calendars/policies/templates/routines/overrides` の schema=1 を定義 | 不正設定が検証エラーで停止する | BS-001 | P0 | 1.5日 |
| BS-003 | ドメインモデル定義 | Block/Routine/Pomodoro 型と変換 I/F を実装 | `bs_*` と内部型の相互変換契約が固定される | BS-002 | P0 | 1日 |
| BS-004 | 状態ストア基盤 | `sync_state/suppressions/logs` の保存 I/F を実装 | Git 管理対象外ディレクトリで永続化できる | BS-001 | P0 | 1日 |

### E1 Calendar 同期
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-010 | OAuth とトークン安全保存 | Google OAuth と refresh を実装し安全領域へ保存 | トークンが Git 管理領域に出ない | BS-001 | P0 | 2日 |
| BS-011 | Blocks カレンダー初期化 | Blocks カレンダーの特定/作成と設定保存 | カレンダー ID を再利用できる | BS-010 | P0 | 1日 |
| BS-012 | `bs_*` イベントマッパー | extendedProperties.private の encode/decode 実装 | `bs_instance` を含む往復変換が壊れない | BS-003, BS-011 | P0 | 1日 |
| BS-013 | 初回フル同期 | `events.list(showDeleted=true)` ページングと `nextSyncToken` 保存 | 初回同期後に state へ token が保存される | BS-004, BS-012 | P0 | 1.5日 |
| BS-014 | 差分同期と 410 復旧 | `syncToken` 差分同期、禁止パラメータ防止、HTTP410 時の再フル同期 | 変更/削除反映と失効復旧が自動化される | BS-013 | P0 | 2日 |

### E2 生成 MVP
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-020 | テンプレ/ルーティーン読込 | `templates.yaml` と `routines/*.yaml` を解析し展開可能化 | `id` 必須チェックと RRULE 読込が通る | BS-002 | P0 | 1.5日 |
| BS-021 | 期待インスタンス集合生成 | 対象日の template+routine から `bs_instance` 集合を構築 | 同日同設定で常に同一集合が得られる | BS-020 | P0 | 1日 |
| BS-022 | keep 戦略の冪等生成 | 既存 `bs_instance` と照合して不足分のみ作成 | 再実行で重複生成しない | BS-014, BS-021 | P0 | 2日 |
| BS-023 | suppression 記録 | `cancelled` + `bs_instance` を `suppressions.json` に反映 | 削除済みインスタンスが state に蓄積される | BS-014, BS-004 | P0 | 1日 |
| BS-024 | suppression 尊重と手動解除生成 | 自動生成は抑止尊重、手動生成は解除して再作成可能にする | 自動復活しない/手動でのみ復活できる | BS-022, BS-023 | P0 | 1.5日 |

### E3 配置戦略
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-030 | busy 収集と統合 | Freebusy + Blocks を統合し busy 区間を構築 | 指定期間の busy が一貫して取得できる | BS-011 | P1 | 1.5日 |
| BS-031 | 空き枠探索エンジン | 勤務窓/バッファ/最小連続時間を満たす候補を算出 | 候補スロットと score/tags が返る | BS-030 | P1 | 2日 |
| BS-032 | shift 戦略実装 | `maxShiftMinutes` と `createIfNoSlot` を反映して配置 | keep と shift を設定で切替可能 | BS-031, BS-022 | P1 | 1.5日 |
| BS-033 | hard/soft 衝突ポリシー | hard/soft の扱いを設定化し探索に反映 | 設定変更で衝突挙動が変わる | BS-031 | P1 | 1日 |

### E4 実行導線
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-040 | CLI コマンド整備 | `sync/generate/catchup/suppress` を実装 | 日付指定で手動生成と同期が可能 | BS-024 | P0 | 1.5日 |
| BS-041 | 毎朝自動生成導線 | Task Scheduler 用実行手順と catch-up 起動処理を実装 | 未実行日の自動補完が働く | BS-040 | P0 | 1日 |
| BS-042 | 最小 UI（日次確認） | 当日ブロック確認、手動生成、プレビュー表示を実装 | 30秒以内の確認フローが成立 | BS-040 | P1 | 2日 |

### E5 実績ログ
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-050 | ポモドーロセッション記録 | focus/break/long_break の実行ログをローカル保存 | セッション開始/終了/中断が追跡できる | BS-004 | P1 | 1.5日 |
| BS-051 | ブロック状態遷移 | running/done/partial/skipped と集計反映を実装 | 日次集計が再現可能 | BS-050, BS-003 | P1 | 1日 |
| BS-052 | 監査ログ実装 | 生成/削除検知/抑止/手動復活をログ化 | 主要イベントが時系列で確認できる | BS-024 | P1 | 1日 |

### E6 Git 同期
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-060 | 設定 Git 同期実装 | `config/` の pull/push フローを整備し `state/` を除外 | 機密/状態が Git に混入しない | BS-002 | P1 | 1.5日 |
| BS-061 | 競合運用ルール整備 | routines 分割前提で競合解決手順と警告を実装 | 競合時に安全に復旧できる | BS-060 | P2 | 1日 |

### E7 品質保証
| ID | タイトル | 内容 | 受け入れ条件 | 依存 | 優先度 | 見積 |
| --- | --- | --- | --- | --- | --- | --- |
| BS-070 | TZ/DST 回帰テスト | 所属日判定、境界時刻、DST 切替のテストを追加 | TZ 由来バグが再発しない | BS-032 | P0 | 1.5日 |
| BS-071 | 統合回帰と出荷チェック | 重複生成・削除復活・同期失敗復旧の統合試験とチェックリスト整備 | v1 完了定義をテストで確認できる | BS-070, BS-052 | P0 | 2日 |

## 4. 実行順（推奨）
1. E0 → E1 → E2 を先行し、P0 の技術リスクを先に潰す。
2. E3 と E4 を並行し、日次運用導線を成立させる。
3. E5/E6 を統合し、最後に E7 で回帰固定と出荷判定を行う。

