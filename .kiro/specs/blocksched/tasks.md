# 実装計画: PomBlock

## 概要

PomBlockは、Tauriベースのデスクトップアプリケーションで、Rustバックエンド（ビジネスロジック、Google Calendar同期、Git同期）とTypeScriptフロントエンド（UI）で構成されます。実装は、インフラストラクチャ層から始めて、ドメイン層、アプリケーション層、UI層の順に進めます。

## タスク

- [x] 1. プロジェクト構造とインフラストラクチャの初期化
  - Tauriプロジェクトの初期化（Rust + TypeScript）
  - 依存関係の追加（proptest, serde, tokio, reqwest, git2, rusqlite等）
  - ディレクトリ構造の作成（src/infrastructure, src/domain, src/application, src-ui）
  - SQLiteデータベーススキーマの作成
  - _要件: 全体_

- [x] 2. OAuth認証とトークン管理の実装
  - [x] 2.1 CredentialStoreトレイトとWindows Credential Manager実装
    - Windows Credential Manager APIを使用したトークン保存/読み込み/削除
    - _要件: 1.2, 1.5_
  
  - [x] 2.2 OAuthトークンのラウンドトリッププロパティテスト
    - **プロパティ1: OAuth トークンのラウンドトリップ**
    - **検証: 要件 1.2**
  
  - [x] 2.3 OAuthManagerの実装
    - Google OAuth 2.0フローの実装（認証、リフレッシュ）
    - トークン有効性チェック
    - _要件: 1.1, 1.3, 1.4_
  
  - [x] 2.4 OAuth認証のプロパティテスト
    - **プロパティ2: 有効なトークンでの再認証不要**
    - **プロパティ3: 無効なトークンでの再認証**
    - **検証: 要件 1.3, 1.4**

- [x] 3. Google Calendar同期サービスの実装
  - [x] 3.1 GoogleCalendarClientの実装
    - Google Calendar API v3クライアント（イベント取得/作成/更新/削除）
    - syncTokenを使用した差分同期
    - _要件: 2.1, 2.2, 2.4_
  
  - [x] 3.2 SyncStateRepositoryの実装
    - syncTokenと最終同期時刻のローカル保存/読み込み
    - _要件: 2.4_
  
  - [x] 3.3 CalendarSyncServiceの実装
    - 差分同期ロジック（追加/更新/削除の検出）
    - ネットワークエラー時のリトライロジック
    - _要件: 2.1, 2.2, 2.3, 2.5_
  
  - [x] 3.4 Calendar同期のプロパティテスト
    - **プロパティ5: 外部編集の検出と反映**
    - **プロパティ6: 同期後のSyncToken保存**
    - **プロパティ7: 同期後のキャッシュ更新**
    - **検証: 要件 2.2, 2.4, 2.5**

- [x] 4. チェックポイント - 認証と同期のテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [x] 5. ドメインモデルの実装
  - [x] 5.1 Block、Task、Pomodoro、Policy、Routine、Templateモデルの定義
    - 各モデルの構造体とenum定義
    - Serdeによるシリアライゼーション/デシリアライゼーション
    - _要件: 3.1, 6.1, 5.1, 10.1, 9.1_
  
  - [x] 5.2 ドメインモデルのユニットテスト
    - 各モデルの基本的な生成と検証
    - _要件: 全ドメインモデル_

- [x] 6. ポリシーエンジンの実装
  - [x] 6.1 Policyの実装
    - 勤務時間チェック（is_within_work_hours）
    - タイムスロットフィルタリング（filter_slots）
    - _要件: 10.2, 10.3_
  
  - [x] 6.2 ポリシーのプロパティテスト
    - **プロパティ29: ユーザー指定値の優先**
    - **検証: 要件 10.3**

- [x] 7. ブロック生成エンジンの実装
  - [x] 7.1 BlockGeneratorの実装
    - 空き時間計算（find_free_slots）
    - ブロック生成（generate_blocks）
    - ブロック再配置（relocate_block）
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 7.2_
  
  - [x] 7.2 ブロック生成のプロパティテスト
    - **プロパティ8: ブロック生成時の重複回避**
    - **プロパティ9: ポリシーに基づく勤務時間制約**
    - **プロパティ10: 生成ブロックのカレンダー登録**
    - **プロパティ11: 重複時間帯での生成防止**
    - **プロパティ23: 重複時のブロック再配置**
    - **検証: 要件 3.3, 3.4, 3.5, 3.6, 7.2, 7.4**

- [x] 8. チェックポイント - ブロック生成のテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [x] 9. ポモドーロタイマーの実装
  - [x] 9.1 PomodoroTimerの実装
    - タイマー状態管理（start, pause, resume, complete）
    - フェーズ遷移（Focus → Break）
    - _要件: 5.1, 5.3, 5.4, 5.5_
  
  - [x] 9.2 PomodoroLogRepositoryの実装
    - ポモドーロ実績のローカル保存/読み込み
    - _要件: 5.5_
  
  - [x] 9.3 ポモドーロのプロパティテスト
    - **プロパティ15: ポモドーロ開始時のタイマー起動**
    - **プロパティ16: 集中時間終了後の休憩開始**
    - **プロパティ17: ポモドーロ中断時のログ記録**
    - **プロパティ18: ポモドーロ実績のログ記録**
    - **検証: 要件 5.1, 5.3, 5.4, 5.5**

- [x] 10. タスク管理の実装
  - [x] 10.1 TaskRepositoryの実装
    - タスクのローカル保存/読み込み/更新
    - _要件: 6.1, 6.2_
  
  - [x] 10.2 TaskManagerの実装
    - タスク作成、一覧取得、ブロックへの割り当て
    - タスク完了、分割、繰り越し
    - _要件: 6.1, 6.2, 6.3, 6.4, 8.2, 8.3, 8.4_
  
  - [x] 10.3 タスク管理のプロパティテスト
    - **プロパティ19: タスクとブロックの関連付け**
    - **プロパティ20: タスク選択のログ記録**
    - **プロパティ21: ブロック開始前のタスク未割り当て**
    - **プロパティ24: タスク繰り越し時の関連付け**
    - **プロパティ25: タスク分割時の小タスク生成**
    - **プロパティ26: 繰り越し・分割のログ記録**
    - **検証: 要件 6.2, 6.3, 6.4, 8.2, 8.3, 8.4**

- [x] 11. Git Repository管理の実装
  - [x] 11.1 GitRepositoryの実装
    - libgit2を使用したGit操作（init, pull, commit, push）
    - ファイル読み書き
    - _要件: 9.1, 9.2, 9.3, 10.1_
  
  - [x] 11.2 RoutineManagerの実装
    - ルーティーンとテンプレートのGit保存/読み込み
    - Git同期
    - _要件: 9.1, 9.2, 9.3, 9.4_
  
  - [x] 11.3 Git同期のプロパティテスト
    - **プロパティ4: 機微情報のGit除外**
    - **プロパティ27: 設定のGitラウンドトリップ**
    - **プロパティ28: Git更新後の設定反映**
    - **検証: 要件 1.5, 9.1, 9.2, 9.3, 9.4, 9.5, 10.1, 10.4**

- [x] 12. チェックポイント - バックエンドコア機能のテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [x] 13. ローカルストレージリポジトリの実装
  - [x] 13.1 LocalStorageRepositoryの実装
    - ブロック、タスク、ポモドーロログ、同期状態の保存/読み込み
    - SQLiteを使用したCRUD操作
    - _要件: 2.4, 2.5, 5.5, 11.1, 11.2_
  
  - [x] 13.2 ローカルストレージのプロパティテスト
    - **プロパティ30: データ削除の完全性**
    - **検証: 要件 11.5**

- [x] 14. ブロック操作の実装
  - [x] 14.1 ブロック承認、削除、時刻調整の実装
    - 確定度更新とカレンダー反映
    - _要件: 4.2, 4.3, 4.4_
  
  - [x] 14.2 ブロック操作のプロパティテスト
    - **プロパティ12: ブロック承認時の確定度更新**
    - **プロパティ13: ブロック削除のカレンダー反映**
    - **プロパティ14: ブロック時刻調整のカレンダー反映**
    - **検証: 要件 4.2, 4.3, 4.4**

- [x] 15. 外部編集処理の実装
  - [x] 15.1 外部編集検出と通知の実装
    - 同期時の変更検出
    - ユーザー通知
    - _要件: 14.1, 14.2, 14.3, 14.4_
  
  - [x] 15.2 外部編集のプロパティテスト
    - **プロパティ22: 新規予定の同期検出**
    - **プロパティ31: 外部編集の変更検出と通知**
    - **検証: 要件 7.1, 14.4**

- [x] 16. 振り返り機能の実装
  - [x] 16.1 振り返りデータ集計の実装
    - 指定期間のポモドーロ実績集計
    - 完了数、中断数、総作業時間の計算
    - _要件: 15.1, 15.2_
  
  - [x] 16.2 振り返りのプロパティテスト
    - **プロパティ32: 振り返りデータの集計正確性**
    - **検証: 要件 15.1, 15.2**

- [x] 17. チェックポイント - バックエンド全機能のテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [x] 18. Tauri Command Handlersの実装
  - [x] 18.1 認証・同期コマンドの実装
    - authenticate_google, sync_calendar
    - _要件: 1.1, 2.1_
  
  - [x] 18.2 ブロック操作コマンドの実装
    - generate_blocks, approve_blocks
    - _要件: 3.1, 4.2_
  
  - [x] 18.3 ポモドーロコマンドの実装
    - start_pomodoro, pause_pomodoro, get_pomodoro_state
    - _要件: 5.1, 5.4_
  
  - [x] 18.4 タスク操作コマンドの実装
    - list_tasks, create_task
    - _要件: 6.1, 6.2_
  
  - [x] 18.5 コマンドハンドラーの統合テスト
    - 各コマンドの基本的な動作確認
    - エラーハンドリングの確認
    - _要件: 全体_

- [ ] 19. TypeScript UIの実装
  - [ ] 19.1 プロジェクト構造とルーティングの設定
    - React/Vue/Svelteのセットアップ
    - ページルーティング（認証、ダッシュボード、ブロック確認、ポモドーロ、タスク、設定）
    - _要件: 全体_
  
  - [ ] 19.2 認証画面の実装
    - OAuth認証フローのUI
    - _要件: 1.1_
  
  - [ ] 19.3 ダッシュボード画面の実装
    - 今日のブロック一覧表示
    - 同期ボタン
    - _要件: 3.1, 4.1_
  
  - [ ] 19.4 ブロック確認・承認画面の実装
    - 生成されたブロックの一覧表示
    - 承認、削除、時刻調整のUI
    - _要件: 4.1, 4.2, 4.3, 4.4_
  
  - [ ] 19.5 ポモドーロ実行画面の実装
    - タイマー表示
    - 開始、一時停止、再開、完了ボタン
    - タスク選択UI
    - _要件: 5.1, 5.2, 5.4, 6.1, 6.2_
  
  - [ ] 19.6 タスク管理画面の実装
    - タスク一覧表示
    - タスク作成、編集、削除UI
    - _要件: 6.1, 6.2_
  
  - [ ] 19.7 振り返り画面の実装
    - 期間選択UI
    - ポモドーロ実績の表示（グラフ/テーブル）
    - _要件: 15.1, 15.2, 15.3, 15.4_
  
  - [ ] 19.8 設定画面の実装
    - ポリシー設定UI（勤務時間、ブロック長、休憩時間）
    - ルーティーン・テンプレート管理UI
    - Git同期設定UI
    - _要件: 9.1, 9.2, 10.1_

- [ ] 20. エラーハンドリングとロギングの実装
  - [ ] 20.1 エラーハンドリングの実装
    - ネットワークエラー、認証エラー、データエラーの処理
    - リトライロジック
    - _要件: 13.1, 13.2, 13.3, 13.4_
  
  - [ ] 20.2 ロギングの実装
    - ローカルログファイルへの記録
    - エラー詳細の記録
    - _要件: 13.1_
  
  - [ ] 20.3 エラーハンドリングのユニットテスト
    - 各エラー種別の処理確認
    - リトライロジックの確認
    - _要件: 13.1, 13.2, 13.3, 13.4_

- [ ] 21. チェックポイント - エンドツーエンドテスト
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 22. パフォーマンス最適化
  - [ ] 22.1 UI応答性の最適化
    - 長時間処理のバックグラウンド実行
    - プログレスインジケーターの実装
    - _要件: 12.1, 12.2, 12.3_
  
  - [ ] 22.2 ブロック生成の最適化
    - 生成から確認までの時間を30秒以内に
    - _要件: 12.4_

- [ ] 23. 最終統合とドキュメント
  - [ ] 23.1 エンドツーエンドワークフローのテスト
    - 認証→同期→ブロック生成→承認→ポモドーロ実行→振り返りの一連の流れ
    - _要件: 全体_
  
  - [ ] 23.2 README作成
    - インストール手順
    - 使用方法
    - 設定方法
  
  - [ ] 23.3 ビルドとパッケージング
    - Tauriビルド設定
    - Windowsインストーラーの作成

## 注意事項

- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
